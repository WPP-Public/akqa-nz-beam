#!/usr/bin/env php
<?php

/**
 * Use the bootstrap to ensure all environment based configs and autoloader are ready
 */
require_once __DIR__ . '/../vendor/autoload.php';

use Heyday\Component\Beam\Compiler;
use Ssh\SshConfigFileConfiguration;
use Ssh\Session;

error_reporting(-1);
ini_set('display_errors', 1);

try {
    $compiler = new Compiler();
    echo $compiler->compile(), PHP_EOL;
    echo 'Publishing', PHP_EOL;
    if (isset($_SERVER['argv'][1]) && $_SERVER['argv'][1] == 'live') {
        $server = array(
            'host' => 'dev2.heyday.net.nz',
            'user' => 'dev',
            'path' => '/home/dev/subdomains/heyday/beam'
        );
    } else {
        $server = array(
            'host' => 'cameron.local',
            'user' => 'cameron',
            'path' => '/Users/cameron/Sites/beam'
        );
    }
    $configuration = new SshConfigFileConfiguration(
        '~/.ssh/config',
        $server['host']
    );
    $session = new Session(
        $configuration,
        $configuration->getAuthentication(
            null,
            $server['user']
        )
    );
    $sftp = $session->getSftp();
    echo 'Sending beam.phar', PHP_EOL;
    $sftp->send(__DIR__ . '/../beam.phar', $server['path'] . '/beam.phar');
    echo 'Sending beam.phar.version', PHP_EOL;
    $sftp->send(__DIR__ . '/../beam.phar.version', $server['path'] . '/beam.phar.version');
    unlink(__DIR__ . '/../beam.phar');
    unlink(__DIR__ . '/../beam.phar.version');

} catch (\Exception $e) {
    echo 'Failed to compile phar: ['.get_class($e).'] '.$e->getMessage().' at '.$e->getFile().':'.$e->getLine();
    exit(1);
}